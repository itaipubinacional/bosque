<!doctype html>
<html lang="en">
<head>
	<link rel="stylesheet" href="ol.css">
	<link rel="stylesheet" href="jquery.mobile-1.4.4.min.css">
	<link rel="stylesheet" href="style.css">
	<title>Geocab</title>
	<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
</head>
<body style="margin: 0">
	<div data-role="popup" id="popupCloseLeft" class="ui-content" style="max-width:280px">

	    <a href="#" data-rel="back" class="ui-btn ui-corner-all ui-shadow ui-btn-a ui-icon-delete ui-btn-icon-notext ui-btn-right">Close</a>

		<div data-role="collapsibleset" id="collapsible-content" >
		</div>
	</div>

	<div id="map" class="map">
	</div>
    
    <script src="jquery-2.1.1.min.js"></script>
    <script src="//http://code.jquery.com/jquery-1.11.1.min.js" type="text/javascript"></script>
    <script src="ol.js"></script>
    <script src="jquery.mobile-1.4.4.js"></script>
	
	<script type="text/javascript">
	
		var view = new ol.View({
		  center: ol.proj.transform([-54.1394, -24.7568], 'EPSG:4326', 'EPSG:3857'),
          zoom: 7
		});

		//var iconFeature = new ol.Feature({
		  //geometry: new ol.geom.Point([0, 0]),
		 // name: 'Ponto perdido',
		  //description: 'Um ponto perdido no meio do nada, pode crer.',
		 // population: 4000,
		//  rainfall: 500
		//});

		//var iconStyle = new ol.style.Style({
		//  image: new ol.style.Icon(/** @type {olx.style.IconOptions} */ ({
	//		anchor: [0.5, 46],
//			anchorXUnits: 'fraction',
//			anchorYUnits: 'pixels',
//			opacity: 0.75,
//			src: 'http://iconshow.me/media/images/Mixed/small-n-flat-icon/png2/48/-map-marker.png'
//		  }))
//		});

//		iconFeature.setStyle(iconStyle);

		// var vectorSource = new ol.source.Vector({
		//   features: [iconFeature]
		// });

		// var vectorLayer = new ol.layer.Vector({
		//   source: vectorSource
		// });

		var wmsSource = new ol.source.TileWMS({
			url: 'http://172.17.6.112/geoserver/sls-sls/wms',
			params: {'LAYERS': 'sls-sls:vslsgeoregiao'},
		});

		var wmsLayer = new ol.layer.Tile({
			source: wmsSource
		});

		var layersAdd = [];
		var markersAdd = [];

		// layersAdd.push({'wmsLayer': wmsLayer, 'wmsSource': wmsSource, 'name': 'vslsgeoregiao', 'title': 'Regiao'});
		
		var map = new ol.Map({
			target: 'map',
			layers: [
			new ol.layer.Tile({
				//source: new ol.source.MapQuest({layer: 'sat'})
				source: new ol.source.OSM()
			})],
			// rotação
            interactions: ol.interaction.defaults({altShiftDragRotate:false, pinchRotate:false, keyboard: false}),
			view: view,
			control: ol.control.defaults({rotate: false})

		});

		$( "#popupCloseLeft" ).bind({
		   popupafterclose: function(event, ui) { 
		   		$('#collapsible-content').html('');
		   }
		});
		
		// display popup on click
		map.on('click', function(evt) {
			features = [];
			features.push(map.forEachFeatureAtPixel(evt.pixel, function(feature, layer) {
				return feature;
			}))

			if (layersAdd.length > 0){

				var listUrls = [];
				var listTitles = [];

                for(var i in layersAdd)
                {
                    var url = layersAdd[i].wmsSource.getGetFeatureInfoUrl(
                        evt.coordinate, view.getResolution(), view.getProjection(),
                        {'INFO_FORMAT': 'application/json'});

                    listUrls.push(decodeURIComponent(url));
                    listTitles.push(layersAdd[i].title);
                }

            }
            var collapsed = true;
			if (features.length > 0 && features[0] != undefined) {
				var html = '';
				for ( var i = 0; i < features.length; i++) {
					getMarkerAtributes(features[i].get('markerId'), features[i].get('name'), collapsed);
					collapsed = false;
				}
			}

			if (listUrls.length > 0) {
				var collapsed = true;
				for (var i in listUrls) {
					getExternalLayerAttributes(listUrls[i], listTitles[i], collapsed);
					collapsed = false;
				}
			}
		});

		function tapholdHandler( event ){
			var getPosition = false;
			map.on('click', function(evt) {
				if( !getPosition )  {
					var lat = evt.coordinate[0];
					var lon = evt.coordinate[1];
					getPosition = true;
					confirmToProceed(lat, lon);
				}
			});
		}
		
		function unbindTouchEvent() {
			$( "div.map" ).unbind( "taphold" );
			map.on('click', function(evt) {
				return null;
			});
		}

		function bindTouchEvent() {
			$( "div.map" ).bind( "taphold", tapholdHandler );
		}

		function showMarker(latitude, longitude, id, name, checked)
		{
			if (checked) {
					// if (fromTap == true) {
				var point = new ol.geom.Point([latitude, longitude])
				// } else {
				// var point = new ol.geom.Point(ol.proj.transform([longitude, latitude], 'EPSG:4326', 'EPSG:3857'))
				// }
				
				var iconFeature = new ol.Feature({
					geometry: point,
					name: name,
					markerId: id
				});

				//create the style
				var iconStyle = new ol.style.Style({
					image: new ol.style.Icon(/** @type {olx.style.IconOptions} */ ({
					size: [48, 48],
					src: 'http://iconshow.me/media/images/Mixed/small-n-flat-icon/png2/48/-map-marker.png'
					}))
				});

				var vectorSource = new ol.source.Vector({
						features: [iconFeature]
				});

				//add the feature vector to the layer vector, and apply a style to whole layer
				var vectorLayer = new ol.layer.Vector({
					source: vectorSource,
					style: iconStyle
				});

				map.addLayer(vectorLayer);
				markersAdd.push({'vectorLayer': vectorLayer, 'name': name});
				// if (!fromTap) zoomToArea(latitude, longitude);
			} else {
				for( var i in markersAdd ) {
				   if( markersAdd[i].name == name ) {
					   map.removeLayer(markersAdd[i].vectorLayer);
					   markersAdd.splice(i,1);
				   }
			   }
			}
			
		}

		function showLayer(url, name, title, checked) {
			if( checked == 'true') {
				var wmsSource = new ol.source.TileWMS({
					url: url,
					params: {'LAYERS': name},
				});

				var wmsLayer = new ol.layer.Tile({
					source: wmsSource
				});

				map.addLayer(wmsLayer);

				layersAdd.push({'wmsLayer': wmsLayer, 'wmsSource': wmsSource, 'name': name, 'title': title});
			} else {
			   for( var i in layersAdd ) {
				   if( layersAdd[i].name == name ) {
					   map.removeLayer(layersAdd[i].wmsLayer);
					   layersAdd.splice(i,1);
				   }
			   }
			}

		}
        
        function removeMarker(name) {
        	var lyr_list = map.getLayers();
	        if (typeOf(lyr_list) === "array") {
        		for (var i in lyr_list) {
               		lyr_list[i].removeAllFeatures();
                    map.removeLayer(lyr_list[i]);
            	}
 			}
        }

        function loadPopupContent (html) {
        	$('#popupCloseLeft').popup('open');
        	$('#collapsible-content').append(html).trigger("create");
        }

        function loadImageContent(id, html){
        	$('#marker-image-' + id).fadeOut("slow", function(){
			  $('#marker-image-' + id).replaceWith(html);
			  $('#marker-image-' + id).fadeIn("slow");
			});
        }
        
        function zoomToArea(latitude, longitude) {
			var pan = ol.animation.pan({
				source: view.getCenter()
			});
			var coordinates = ol.proj.transform([longitude, latitude], 'EPSG:4326', 'EPSG:3857');
			map.beforeRender(pan);
			view.setCenter(coordinates);
			view.setZoom(14);
		}
	</script>

</body>
</html>
